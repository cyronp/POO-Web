<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/edit_movie.css" />
    <title>UnivilleDb - Editar</title>
  </head>
  <body>
    <div class="header">
      <div class="icon">
        <h1 class="title">UnivilleDb</h1>
      </div>
      <div class="header-nav">
        <a class="sub-title" href="/movies_all">Ver todos</a>
        <a class="sub-title">Listar Filmes</a>
        <a class="sub-title">Listar Series</a>
        <a class="sub-title">Serie com maior nota</a>
        <a class="sub-title">Filme com maior nota</a>
        <a class="sub-title" href="/delete_movie"
          >Deletar Filme/Serie</a
        >
        <a class="sub-title" href="/edit_movie"
          >Editar Filme/Serie</a
        >
        <a class="sub-title" href="/create_movie"
          >Criar Filme/Serie</a
        >
      </div>
    </div>
    <div class="main-content">
      <div class="content">
        <h2 class="content-title">Editar Filme/Série</h2>
        <p class="content-subtitle">
          Busque o conteúdo pelo ID e edite as informações
        </p>

        <div class="search-container">
          <div class="search-box">
            <label for="searchId">ID do Filme/Série*</label>
            <div class="search-input-group">
              <input
                type="number"
                id="searchId"
                name="searchId"
                placeholder="Digite o ID do conteúdo"
                min="1"
              />
              <button
                type="button"
                class="btn-search"
                onclick="searchContent()"
              >
                Buscar
              </button>
            </div>
          </div>
        </div>

        <div class="form-container" id="formContainer" style="display: none">
          <form class="movie-form" id="movieForm">
            <input type="hidden" id="contentId" name="contentId" />

            <div class="form-section">
              <h3 class="section-title">Informações Básicas</h3>

              <div class="form-group">
                <label for="contentType">Tipo de Conteúdo*</label>
                <select id="contentType" name="contentType" required>
                  <option value="">Selecione...</option>
                  <option value="movie">Filme</option>
                  <option value="series">Série</option>
                </select>
              </div>

              <div class="form-group">
                <label for="title">Título*</label>
                <input
                  type="text"
                  id="title"
                  name="title"
                  placeholder="Ex: The Boys"
                  required
                />
              </div>

              <div class="form-group">
                <label for="imageUrl">URL da Imagem*</label>
                <input
                  type="url"
                  id="imageUrl"
                  name="imageUrl"
                  placeholder="https://exemplo.com/imagem.jpg"
                  required
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="rating">Avaliação (0-10)*</label>
                  <input
                    type="number"
                    id="rating"
                    name="rating"
                    min="0"
                    max="10"
                    step="0.1"
                    placeholder="8.6"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="duration">Duração/Episódios*</label>
                  <input
                    type="text"
                    id="duration"
                    name="duration"
                    placeholder="Ex: 40 Episodios ou 120 min"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="section-title">Equipe</h3>

              <div class="form-group">
                <label for="director">Diretor/Criador*</label>
                <input
                  type="text"
                  id="director"
                  name="director"
                  placeholder="Ex: Eric Kripke"
                  required
                />
              </div>
            </div>

            <div class="form-section">
              <h3 class="section-title">Categorias</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="genre">Gênero Principal*</label>
                  <input
                    type="text"
                    id="genre"
                    name="genre"
                    placeholder="Ex: Comédia"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="subGenre">Gênero Secundário</label>
                  <input
                    type="text"
                    id="subGenre"
                    name="subGenre"
                    placeholder="Ex: Heróis"
                  />
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-cancel" onclick="history.back()">
                Cancelar
              </button>
              <button type="submit" class="btn-submit">
                Salvar Alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>

        function searchContent() {
            const id = document.getElementById("searchId").value;

            if (!id || id <= 0) {
                alert("Por favor, digite um ID válido (número positivo).");
                document.getElementById("formContainer").style.display = "none";
                return;
            }


            fetch(`/api/midias/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Conteúdo não encontrado ou erro na busca.");
                    }
                    return response.json();
                })
                .then(data => {

                    document.getElementById("contentId").value = data.id;
                    document.getElementById("contentType").value = data.tipo === "Filme" ? "movie" : "series";
                    document.getElementById("title").value = data.titulo;
                    document.getElementById("imageUrl").value = data.capaUrl;
                    document.getElementById("rating").value = data.nota;
                    document.getElementById("duration").value = data.duracao; // O Spring pode retornar a duração em formato numérico
                    document.getElementById("director").value = data.criador;
                    document.getElementById("genre").value = data.genero;
                    document.getElementById("subGenre").value = data.subGenero;

                    document.getElementById("formContainer").style.display = "block";
                    document.getElementById("formContainer").scrollIntoView({ behavior: "smooth" });
                })
                .catch(error => {
                    alert("Erro ao buscar conteúdo: " + error.message);
                    document.getElementById("formContainer").style.display = "none";
                });
        }

        document
            .getElementById("movieForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const id = document.getElementById("contentId").value;
                if (!id) {
                    alert("Erro: ID do conteúdo não encontrado.");
                    return;
                }

                const formData = {
                    id: parseInt(id),
                    titulo: document.getElementById("title").value,
                    nota: parseFloat(document.getElementById("rating").value),
                    tipo: document.getElementById("contentType").value === "movie" ? "Filme" : "Serie",
                    duracao: parseInt(document.getElementById("duration").value.match(/\d+/)[0]),
                    criador: document.getElementById("director").value,
                    genero: document.getElementById("genre").value,
                    subGenero: document.getElementById("subGenre").value,
                    capaUrl: document.getElementById("imageUrl").value,
                };

                fetch(`/api/midias/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(formData),
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || "Erro desconhecido ao salvar as alterações.");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert("Conteúdo atualizado com sucesso! ID: " + data.id);
                        window.location.href = "/movies_all";
                    })
                    .catch(error => {
                        console.error("Erro ao atualizar:", error);
                        alert("Erro ao atualizar: " + error.message);
                    });
            });

      document
        .getElementById("searchId")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            searchContent();
          }
        });
    </script>
  </body>
</html>
